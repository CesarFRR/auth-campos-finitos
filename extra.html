<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suma Modular Animada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
            font-family: sans-serif;
        }
        #canvas-container {
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
            background-color: #e0f7ff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            user-select: none;
            -webkit-user-select: none;
        }
        button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="canvas-container">
        <script>
            // --- Configuración y Estado ---
            let pointPosition;
            let startPixelPos, targetPixelPos;
            
            let animationProgress = 0;
            let isAnimating = false;
            
            const startStep = 3;
            const stepsToMove = 2;
            const modulo = 7;
            const finalStep = (startStep + stepsToMove) % modulo;

            const stepPixelSize = 100;
            const xOffset = 50;
            
            let lastPlayedNoteIndex = -1;
            let sampler;
            const notes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4'];
            const soundFiles = { 'C4': 'https://storage.googleapis.com/assessment-2-dev-383715.appspot.com/bell-C4.mp3', 'D4': 'https://storage.googleapis.com/assessment-2-dev-383715.appspot.com/bell-D4.mp3', 'E4': 'https://storage.googleapis.com/assessment-2-dev-383715.appspot.com/bell-E4.mp3', 'F4': 'https://storage.googleapis.com/assessment-2-dev-383715.appspot.com/bell-F4.mp3', 'G4': 'https://storage.googleapis.com/assessment-2-dev-383715.appspot.com/bell-G4.mp3', 'A4': 'https://storage.googleapis.com/assessment-2-dev-383715.appspot.com/bell-A4.mp3', 'B4': 'https://storage.googleapis.com/assessment-2-dev-383715.appspot.com/bell-B4.mp3' };
            
            // --- Funciones Principales de p5.js ---
            function preload() {
                sampler = new Tone.Sampler(soundFiles).toDestination();
            }

            function setup() {
                let canvas = createCanvas(750, 150);
                canvas.parent('canvas-container');
                
                // Definir las posiciones en píxeles
                startPixelPos = xOffset + startStep * stepPixelSize;
                targetPixelPos = xOffset + finalStep * stepPixelSize;
                
                // ESTA LÍNEA ES CLAVE: Dibuja el estado inicial con el punto en la posición de partida.
                pointPosition = startPixelPos;
                drawScene(); 
                
                // Detener el bucle de dibujo para que la animación no empiece sola.
                noLoop(); 
            }

            function draw() {
                if (!isAnimating) return;

                // Actualizar progreso
                animationProgress += 0.01;
                
                // Calcular posición con suavizado
                const easedProgress = easeInOut(animationProgress);
                pointPosition = lerp(startPixelPos, targetPixelPos, easedProgress);
                
                // Redibujar todo
                drawScene();
                
                // Manejar sonido
                const currentNoteIndex = Math.round((pointPosition - xOffset) / stepPixelSize);
                if (currentNoteIndex > lastPlayedNoteIndex) {
                    playSound(currentNoteIndex);
                    lastPlayedNoteIndex = currentNoteIndex;
                }

                // Detener la animación al terminar
                if (animationProgress >= 1.0) {
                    pointPosition = targetPixelPos; // Asegurar la posición final
                    drawScene(); // Dibujar el cuadro final
                    isAnimating = false;
                    noLoop();
                }
            }

            // --- Funciones de Dibujo ---
            function drawScene() {
                background(224, 247, 255);
                drawOperationText();
                drawNumberLine();
                drawDot();
            }

            function drawDot() {
                fill(255, 0, 0);
                noStroke();
                ellipse(pointPosition, 100, 15, 15);
            }

            function drawNumberLine() {
                stroke(0); strokeWeight(2);
                line(xOffset, 100, (modulo * stepPixelSize) - xOffset, 100);
                for (let i = 0; i < modulo; i++) {
                    const x = xOffset + i * stepPixelSize;
                    line(x, 95, x, 105);
                    noStroke(); fill(0); textAlign(CENTER); textSize(16);
                    text(i, x, 130);
                }
            }
            
            function drawOperationText() {
                fill(0); textSize(24); textAlign(CENTER);
                text(`(${startStep} + ${stepsToMove}) mod ${modulo} = ${finalStep}`, width / 2, 40);
            }

            // --- Funciones Auxiliares ---
            function playSound(noteIndex) {
                if (sampler.loaded && noteIndex >= 0 && noteIndex < notes.length) {
                    sampler.triggerAttackRelease(notes[noteIndex], '8n');
                }
            }

            function easeInOut(t) { return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t; }
            
            function playAnimation() {
                if (isAnimating) return;

                if (Tone.context.state !== 'running') { Tone.start(); }
                
                animationProgress = 0;
                lastPlayedNoteIndex = startStep - 1;
                isAnimating = true;
                
                playSound(startStep);
                loop(); // Iniciar el bucle de dibujo de p5.js
            }
        </script>
    </div>
    <button id="playButton">Play</button>

    <script>
        document.getElementById('playButton').addEventListener('click', () => {
            playAnimation();
        });
    </script>
</body>
</html>